
<!DOCTYPE html>

<html>
<head><meta content="noindex,nofollow" name="robots"/>
<title>A Hazard of Covariant Return Types and Bridge Methods</title>
<meta charset="utf-8"/>
<meta content="Ian Robertson" name="author">
<link href="../_/https/www.artima.com/artima.css" rel="stylesheet" type="text/css"/>
<link href="../_/https/www.artima.com/favicon.ico" rel="shortcut icon"/>
</meta></head>
<body><table cellspacing="0" width="100%">
<tr>
<td align="left" valign="bottom">
<a href="../_/https/www.artima.com/index.html"><img alt="The Artima Developer Community" border="0" height="43" src="../_/https/www.artima.com/images/a7.gif" width="550"/></a>
</td>
</tr></table>
<table bgcolor="#333333" width="100%">
<tr>
<td align="center">
<div class="ml">
<a class="hl" href="../_/https/www.artima.com/articles/index.html">Articles</a> |
<a class="hl" href="../_/https/www.artima.com/news/index.html">News</a> |
<a class="hl" href="../index.html">Weblogs</a> |
<a class="hl" href="../_/https/www.artima.com/shop/catalog/index.html">Books</a> |
<a class="hl" href="../_/https/www.artima.com/forums/index.html">Forums</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#CCCCCC" width="100%">
<tr>
<td align="center">
<div class="sc">
<a href="../index.html">Artima Weblogs</a> | 

<a href="../index.html$/blogger=ianr.html">Ian Robertson's Weblog</a> | 

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=354443.html">Discuss</a> | 
<a href="mailto:?subject=A Hazard of Covariant Return Types and Bridge Methods&amp;body= %0AArtima Weblogs %0AA Hazard of Covariant Return Types and Bridge Methods %0Aby Ian Robertson %0A%0Ahttps://www.artima.com/weblogs/viewpost.jsp?thread=354443">Email</a> | 
<a href="../viewpostP.html$/thread=354443.html">Print</a> | 
<a href="../bloggers.html">Bloggers</a> | 
<a class="sl" href="thread=335110.html" title="Static Typing, Guard Rails and Street Signs">Previous</a> | 
<a class="sl" href="thread=361795.html" title="Announcing Pojomatic 2.0">Next</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#EEEEEE" width="100%">
<tr>
<td align="center">
<div class="sc">
<span style="color: #555555;">Sponsored Link</span> <span style="color: #888888;">•</span>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
   if (!document.phpAds_used) document.phpAds_used = ',';
   phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
   
   document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
   document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
   document.write ("&amp;what=zone:9&amp;target=_top");   document.write ("&amp;exclude=" + document.phpAds_used);
   if (document.referrer)
      document.write ("&amp;referer=" + escape(document.referrer));
   document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a799ecf6.html" target="_top"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:9&amp;n=a0587811.html"/></a></noscript>
</div>
</td>
</tr>
</table>
<br/>
<div class="vegies">
<div class="tc">
<span class="sts">Code by Any Other Name</span><br>
<span class="ts">A Hazard of Covariant Return Types and Bridge Methods</span><br/>
<span class="as">by Ian Robertson</span><br/>
<span class="pd">September 25, 2013</span><br/>
</br></div>
<blockquote>
<b>Summary</b><br/>
A combination of bridge methods, covariant return types and dynamic dispatch can lead to some surprising and unfortunate results.

</blockquote>
<hr align="left" width="90%"/>
<table align="right">
<tr>
<td>
<div class="adnotice">
Advertisement
</div>
<center>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
if (!document.phpAds_used) document.phpAds_used = ',';
phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
document.write ("&amp;what=zone:2");
document.write ("&amp;exclude=" + document.phpAds_used);
if (document.referrer)
document.write ("&amp;referer=" + escape(document.referrer));
document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a74ab060.html" target="_blank"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:2&amp;n=a74ab060.html"/></a></noscript>
</center>
</td>
</tr>
</table>
<p>
<style type="text/css">
   code.nowrap {
     white-space: nowrap;
   }
   pre {
    box-shadow: 5px 5px 5px #888;
    background-color: #eee;
    margin: 10px;
    border-radius: 5px;
    width: 40em;
    padding: 5px;
   }
 </style>
<h1>A Hazard of Covariant Return Types and Bridge Methods</h1>
<p>
  This week at JavaOne, Joe Darcy pointed out to me an interesting
  difficulty he ran into recently when trying to change various JDK
  classes to use covariant return types for clone(). It turns out that
  changing the return type of an overridden method on a class to be
  more specific can break behavior compatibility for child classes
  which themselves had already created an override of the same method.
  The original discussion is on
  the <a href="../_/http/mail.openjdk.java.net/pipermail/core-libs-dev/2012-January/009119.html">OpenJdk
  Core Libs Dev</a> mailing list. To try to make it a touch easier to
  follow, I'll give a bit of background, and construct a stand-alone example.
</p>
<h2>Method invocation in the JVM</h2>
<p>
The Java language (as most OO languages) offers some flexibility when
making method calls. Given the following class<a href="#footnote1"><sup>[1]</sup></a>:

<code>
<pre>
import java.util.*;

public class Wrapper {
  public Collection wrap(Object o) {
    List l = new ArrayList();
    l.add(o);
    return l;
  }
}
</pre>
</code>
it is possible to call this method as follows:

<code>
<pre>
public class WrapperClient {
  public static void main(String args[]) {
    Object wrappped = new Wrapper().wrap("x");
  }
}
</pre>
</code>
</p>
<p>
This is
the <a href="../_/http/en.wikipedia.org/wiki/Liskov_substitution_principle/index.html">Liskov
Substitution Principal</a> in action. While <code>wrap</code> is expecting an
<code>Object</code>, it's fine to pass in a subtype of <code>Object</code> (in this case,
<code>String</code>). Similarly, while the return type
of <code>wrapped</code> is of type <code>Object</code>, it's fine to
assign a subtype of <code>Object</code> to it. As we know, Java respects this, and
makes it work. What is not as well known is exactly <em>how</em> Java
makes this work.
</p>
<p>
To see what is happening under the hood, we need to understand how
method calls look in the Java Virtual Machine. Rather than show
disassembled byte code the way <code class="nowrap">javap -c</code> would, I'll
introduce a bit of pseudocode syntax. When a method is called, I'm
going to add the precise signature of the method after the method
name, in brackets. In this pseudo code, the above call to wrap now
looks like:
</p>
<code>
<pre>
Object wrapped = new Wrapper().wrap[Object-&gt;Collection]("x");
</pre>
</code>
<p>
The JVM honors Liskov Substution, in the sense that it is perfectly
willing to invoke <code class="nowrap">wrap[Object-&gt;Collection]</code>, even thought
the type being passed in is not <code>Object</code>, but a subtype of
<code>Object</code>. Similarly, it's willing to assign the result of
this method invocation (declared to be a <code>Collection</code>) to a
variable of type <code>Object</code>, a supertype of <code>Collection</code>.
</p>
<p>
There's a subtle issue here which is easy to overlook. While the JVM
honors Liskov Substution perfectly well when it comes to accepting
subtypes of what a method call or assignment operator expects, it
will <em>not</em> look for method signatures that would work in the
place of the signature asked for. To see this in action, recompile
Wrapper.java with the following source code:
<code>
<pre>
public class Wrapper {
  public Collection wrap(String o) {
    Collection c = new ArrayList();
    c.add(o);
    return c;
  }
}
</pre>
</code>
<p>
If <code>WrapperClient</code> is run again against the newly
compiled <code>Wrapper</code> class without also
recompiling WrapperClient.java, a <code>NoSuchMethodError</code> will be thrown. This is
because Wrapper is looking for a method with signature
<code class="nowrap">wrap[Object-&gt;Collection]</code>, but the only wrap method
present in Wrapper is <code class="nowrap">wrap[String-&gt;Collection]</code>. While this would be an
acceptable substitution, the JVM will not make it for us.
</p>
<h2>Covariant returns and Bridge methods</h2>
<p>
Prior to Java 5, overrides of a method in a subclass could not change
the return type of the method. If <code>WrapperChild</code> were to
extend <code>Wrapper</code>, it would only have one option for the
return type of <code>wrapper</code>, namely <code>Collection</code>:
</p>
<code>
<pre>
import java.util.*;
public class WrapperChild extends Wrapper {
  @Override
  public Collection wrap(Object o) {
    return super.wrap(o);
  }
}
</pre>
</code>
<p>
Starting in Java 5, support
for <a href="../_/http/en.wikipedia.org/wiki/Covariant_return_type/index.html">covariant
return types</a> was introduced added. This means that we can now
subclass <code>WrapperChild</code>, and override the <code>wrap</code>
method to return a type more specific than <code>Collection</code>:
</p>
<code>
<pre>
import java.util.*;
public class WrapperGrandchild extends WrapperChild {
  @Override
  public List wrap(Object o) {
    return (List) (super.wrap(o));
  }
}
</pre>
</code>

Suppose we have code calling <code>wrap</code> on a variable declared
to be of type <code>Wrapper</code> which is actually of
type <code>WrapperGrandchild</code>. How does Java avoid
a <code>NoSuchMethodError</code>? It turns out that the work is done
not by the JVM, but by javac. When <code>WrapperGrandchild</code> is
compiled, a bridge method is created with the signature of the
parent <code>wrap</code> method which forwards to the
new <code>wrap</code> method. The resulting class looks like:
<code>
<pre>
import java.util.*;
public class WrapperGrandchild extends WrapperChild {
  public List wrap(Object o) {
    return (List) (super.wrap[Object-&gt;Collection](o));
  }

  // bridge method created by javac
  public Collection wrap(Object o) {
    return this.wrap[Object-&gt;List].wrap(o));
  }
}
</pre>
</code>
<p>
Thus, a client which has an instance with declared
type <code>WrapperChild</code>, but actual
type <code>WrapperGrandchild</code>, can still successfully invoke
<code class="nowrap">WrapperGrandchild.wrap[Object-&gt;Collection]</code>.
</p>
<h2>The Trap</h2>
<p>
Now that we understand covariant overrides and bridge methods, we can
understand the problem that Joe ran into. Suppose that while <code>Wrapper</code>
and <code>WrapperChild</code> are distributed in the same jar,
<code>WrapperGrandchild</code> is distributed in a separate jar which has a
separate release schedule. Suppose further that the maintainer of
<code>WrapperChild</code> decides to change the signature of
its <code>wrap</code> method to return <code>List</code> instead
of <code>Collection</code>. Because the original <code>Wrapper</code>
class still is defining wrap to
return <code>Collection</code>, <code>WrapperChild.class</code> must
now contain a bridge method:
</p>
<code>
<pre>
import java.util.*;
public class WrapperChild extends Wrapper {
  public List wrap(Object o) {
    return (List) (super.wrap[Object-&gt;Collection](o));
  }

  // bridge method created by javac
  public Collection wrap(Object o) {
    return this.wrap[Object-&gt;List].wrap(o));
  }
}
</pre>
</code>
<p>
Suppose that <code>WrapperGrandchild</code> is not recompiled against
the new version of <code>WrapperChild</code>. Consider what happens if
someone calls:
<code><pre>new WrapperGrandchild().wrap("x")</pre></code>

First, the <code class="nowrap">wrap[Object-&gt;List]</code> method
on <code>WrapperGrandchild</code> is invoked. This calls
<code class="nowrap">super.wrap[Object-&gt;Collection]</code> (the only signature that
was available in the first version of
<code>WrapperChild</code>). However, <code>WrapperChild</code>'s
<code class="nowrap">wrap[Object-&gt;Collection]</code> method is now a bridge method
that forwards to <code class="nowrap">wrap[Object-&gt;List]</code>. Due to dynamic
dispatch, the most specific override
of <code class="nowrap">wrap[Object-&gt;List]</code> is invoked. Unfortunately, this is
the orginal <code class="nowrap">wrap[Object-&gt;List]</code> method
on <code>WrapperGrandchild</code> that we first called!  We now have
an infinite loop (or more precisely, a
<code>StackOverflowError</code>). The combination of bridge methods,
dynamic dispatch and partial recompilation has led us into a corner.
</p>
<p>
The good news is that this is a rather obscure edge case that most of
us won't hit in practice. It requires three levels of inheritance for
a method, with each child invoking super. It also requires a very
specific combination of covariant return types at each inheritance
level, and a specifc sequence of releases. The danger remains,
however, especially for environments with multiple layers of
dependencies which evolve on different time lines, or for widely used
libraries (such as the core JDK libraries).
</p>
<img align="top" height="15" src="../_/https/www.artima.com/images/ik.gif" width="15"/>
<ol style="padding-left:1.5em;">
<li><a name="footnote1"></a>Of course the code here should properly use generics. I've
ommitted them for conciseness, and to avoid causing the impression
that the issue described here is related to generics</li>
</ol>
<h1>Talk Back!</h1>
<p>
Have an opinion?


Readers have already posted

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=354443.html">4

comments</a>
about this weblog entry. Why not

<a href="../_/https/www.artima.com/forums/post.html$/forum=106&amp;thread=354443&amp;reply=true.html">add yours</a>?


<h1>RSS Feed</h1>
<p>
If you'd like to be notified whenever Ian Robertson adds a new entry to <a href="../index.html$/blogger=ianr.html">his weblog</a>, subscribe to his <a href="../feeds/bloggers/ianr.rss">RSS feed</a>.

<center>
<div class="sociallinks">
<a href="../_/http/digg.com/submit$/phase=2&amp;url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D354443&amp;title=A+Hazard+of+Covariant+Return+Types+and+Bridge+Methods&amp;bodytext=A+combination+of+bridge+methods%2C+covariant+return+types+and+dynamic+dispatch+can+lead+to+some+surprising+and+unfortunate+results.&amp;topic=programming">
<img alt="Digg" border="0" height="14" hspace="8" src="../_/https/www.artima.com/images/digg.gif" width="16">Digg
  </img></a>
  |
  <a href="../_/http/del.icio.us/post$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D354443&amp;title=A+Hazard+of+Covariant+Return+Types+and+Bridge+Methods">
<img alt="del.icio.us" border="0" height="16" hspace="8" src="../_/https/www.artima.com/images/delicious.gif" vspace="1" width="16">del.icio.us
  </img></a>
  |
  <a href="../_/http/programming.reddit.com/submit$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D354443&amp;title=A+Hazard+of+Covariant+Return+Types+and+Bridge+Methods">
<img alt="Reddit" border="0" height="18" hspace="8" src="../_/https/www.artima.com/images/reddit.gif" width="18">Reddit
  </img></a>
</div>
</center>
<h1>About the Blogger</h1>
<p>
<table><tr valign="bottom"><td><img align="right" src="../_/https/www.artima.com/images/ianRobertson.jpg"/></td><td>Ian Robertson is an application architect at Verisk Health. He is interested in finding concise means of expression in Java without sacrificing type safety. He contributes to various open source projects, including <a href="../_/http/www.jamon.org/index.html">jamon</a> and <a href="../_/http/www.pojomatic.org/index.html">pojomatic</a>.</td></tr></table><p>
<div class="sp">This weblog entry is Copyright © 2013 Ian Robertson. All rights reserved.</div>
</p></p></p></p></p></p></div>

<hr width="100%">
<table align="center" width="50%">
<tr>
<td>
<div class="horizontaltextadbox">
<div class="adheadline">Sponsored Links</div>
<div id="sponsoredlinks">
</div>
</div>
</td>
</tr>
</table>
<hr width="100%"/>
<center>
<script type="text/javascript"><!--
google_ad_client = "pub-3911176865765226";
google_alternate_color = "ffffff";
google_ad_width = 728;
google_ad_height = 15;
google_ad_format = "728x15_0ads_al";
google_ad_channel = "";
google_color_border = "ffffff";
google_color_bg = "FFFFFF";
google_color_link = "003090";
google_color_text = "000000";
google_color_url = "666666";
//--></script>
<script src="../_/https/pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
</script>
<br>
<br/>
<!-- SiteSearch Google -->
<form action="../_/https/www.google.com/custom/index.html" method="get">
<table bgcolor="#ffffff" border="0">
<tr><td align="left" height="32" nowrap="nowrap" valign="top">
<a href="../_/https/www.google.com/index.html">
<img alt="Google" border="0" src="../_/https/www.google.com/logos/Logo_25wht.gif"/></a>
</td>
<td nowrap="nowrap">
<input name="domains" type="hidden" value="Artima.com"/>
<input maxlength="255" name="q" size="31" type="text" value=""/>
<input name="sa" type="submit" value="Search"/>
</td></tr>
<tr>
<td> </td>
<td nowrap="nowrap">
<font color="#000000" size="-1">
<input name="sitesearch" type="radio" value=""/> Web
<input checked="checked" name="sitesearch" type="radio" value="Artima.com"/>Artima.com
</font>  
<input name="client" type="hidden" value="pub-3911176865765226"/>
<input name="forid" type="hidden" value="1"/>
<input name="ie" type="hidden" value="ISO-8859-1"/>
<input name="oe" type="hidden" value="ISO-8859-1"/>
<input name="cof" type="hidden" value="GALT:#008000;GL:1;DIV:#336699;VLC:663399;AH:center;BGC:FFFFFF;LBGC:FFFFFF;ALC:0000FF;LC:0000FF;T:000000;GFNT:0000FF;GIMP:0000FF;LH:50;LW:150;L:https://www.artima.com/images/artima150.gif;S:https://www.artima.com;FORID:1;"/>
<input name="hl" type="hidden" value="en"/>
</td></tr></table>
</form>
<!-- SiteSearch Google -->
</br></center>
<br/>
<div class="sp">
<div style="text-align: center;">
<a href="../_/https/www.artima.com/copyright.html">Copyright</a> © 1996-2019 Artima, Inc. All Rights Reserved. - <a href="../_/https/www.artima.com/privacy.html">Privacy Policy</a> - <a href="../_/https/www.artima.com/termsofuse.html">Terms of Use</a>
</div>
</div>
<br/>
<script language="JavaScript" type="text/javascript">
<!--
function initBannerVarForZone(zone) {
        initBannerVarForZoneWithScript(zone, 'adjs_modified');
}

function initBannerVarForZoneWithScript(zone, phpScript) {

        if (!document.phpAds_used) document.phpAds_used = ',';
        phpAds_random = new String (Math.random());
        phpAds_random = phpAds_random.substring(2,11);

        var nextScriptSrc = '../_/https/www.artima.com/zcr/index.html' + phpScript + '.php?n=' +
                phpAds_random  +
                '&amp;what=zone:' + zone + '&amp;target=_top&amp;block=1&amp;blockcampaign=1' +
                '&amp;exclude=' + document.phpAds_used;

        document.write("<script language='JavaScript' type='text/javascript' src='");
        document.write(nextScriptSrc);
        document.write("'><\/script>");

}

function replaceDiv(divID) {
        document.getElementById(divID).innerHTML = phpadsbanner;
}
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZone(3);
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('leftskyscraper');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZoneWithScript(4, 'textman');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('sponsoredlinks');
-->
</script>
</hr><a href="https://dafoster.net/projects/crystal-web-archiver/" id="cr-footer-banner" style="border-top: 2px #B40010 solid;background: #FFFAE1;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;font-variant: initial;font-weight: initial;text-transform: none;font-size: 14px;color: #6c757d;line-height: 2.0;cursor: pointer;display: flex;align-items: center;justify-content: center;gap: 4px;clear: both;" target="_blank"><img height="24" onerror="this.style['display'] = 'none';" src="../_/crystal/resources/appicon.png" width="24"/><span>This page was archived with Crystal</span><script>window.addEventListener('load', function() { const $1 = document.querySelector('#cr-footer-banner'); if (!$1) { return; } if (window !== window.top) { let $2 = false; if (window.name) { const $3 = window.parent.document.getElementsByName(window.name); if ($3.length === 1) { const $4 = $3[0]; if ($4.tagName === 'FRAME' && $4.parentElement.tagName === 'FRAMESET') { let $5 = $4; while (true) { if ($5.parentElement.tagName !== 'FRAMESET') { $2 = true; break; } if ($5.parentElement.attributes['rows'] !== undefined) { const $6 = $5.parentElement.children; if ($5 === $6[$6.length - 1]) { $5 = $5.parentElement; continue; } else { break; } } else if ($5.parentElement.attributes['cols'] !== undefined) { const $7 = Array.from($5.parentElement.children); const $8 = $7.indexOf($5); if ($8 === -1) { break; } const $9 = $5.parentElement.attributes['cols'].value.split(','); const $10 = $9.map((s) => parseInt(s.trim())); if ($9[$8].trim() === '*' || $10[$8] === Math.max.apply(null, $10)) { $5 = $5.parentElement; continue; } else { break; } } else { break; } } } } } if (!$2) { $1.style['display'] = 'none'; } } const $11 = $1.getBoundingClientRect(); const $12 = ($11.y < window.innerHeight - $11.height); if ($12) { $1.style['position'] = 'fixed'; $1.style['bottom'] = '0'; $1.style['left'] = '0'; $1.style['right'] = '0'; $1.style['z-index'] = '9999'; } const $13 = ( document.body.getBoundingClientRect().height < $11.height * 2 ); if ($13) { $1.style['display'] = 'none'; }
});</script></a></body>
</html>
