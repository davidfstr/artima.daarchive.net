
<!DOCTYPE html>

<html>
<head><meta content="noindex,nofollow" name="robots"/>
<title>An Alternative to Closure Conversion and to Restricted Closures</title>
<meta charset="utf-8"/>
<meta content="Howard Lovatt" name="author">
<link href="../_/https/www.artima.com/artima.css" rel="stylesheet" type="text/css"/>
<link href="../_/https/www.artima.com/favicon.ico" rel="shortcut icon"/>
</meta></head>
<body><table cellspacing="0" width="100%">
<tr>
<td align="left" valign="bottom">
<a href="../_/https/www.artima.com/index.html"><img alt="The Artima Developer Community" border="0" height="43" src="../_/https/www.artima.com/images/a7.gif" width="550"/></a>
</td>
</tr></table>
<table bgcolor="#333333" width="100%">
<tr>
<td align="center">
<div class="ml">
<a class="hl" href="../_/https/www.artima.com/articles/index.html">Articles</a> |
<a class="hl" href="../_/https/www.artima.com/news/index.html">News</a> |
<a class="hl" href="../index.html">Weblogs</a> |
<a class="hl" href="../_/https/www.artima.com/shop/catalog/index.html">Books</a> |
<a class="hl" href="../_/https/www.artima.com/forums/index.html">Forums</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#CCCCCC" width="100%">
<tr>
<td align="center">
<div class="sc">
<a href="../index.html">Artima Weblogs</a> | 

<a href="../index.html$/blogger=hlovatt.html">Howard Lovatt's Weblog</a> | 

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=220920.html">Discuss</a> | 
<a href="mailto:?subject=An Alternative to Closure Conversion and to Restricted Closures&amp;body= %0AArtima Weblogs %0AAn Alternative to Closure Conversion and to Restricted Closures %0Aby Howard Lovatt %0A%0Ahttps://www.artima.com/weblogs/viewpost.jsp?thread=220920">Email</a> | 
<a href="../viewpostP.html$/thread=220920.html">Print</a> | 
<a href="../bloggers.html">Bloggers</a> | 
<a class="sl" href="thread=220916.html" title="Traits for Java">Previous</a> | 
<a class="sl" href="thread=222021.html" title="Simplyfing Java Generics by Eliminating Wildcards">Next</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#EEEEEE" width="100%">
<tr>
<td align="center">
<div class="sc">
<span style="color: #555555;">Sponsored Link</span> <span style="color: #888888;">•</span>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
   if (!document.phpAds_used) document.phpAds_used = ',';
   phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
   
   document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
   document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
   document.write ("&amp;what=zone:9&amp;target=_top");   document.write ("&amp;exclude=" + document.phpAds_used);
   if (document.referrer)
      document.write ("&amp;referer=" + escape(document.referrer));
   document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a799ecf6.html" target="_top"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:9&amp;n=a0587811.html"/></a></noscript>
</div>
</td>
</tr>
</table>
<br/>
<div class="vegies">
<div class="tc">
<span class="sts">Pattern Centric Blog</span><br>
<span class="ts">An Alternative to Closure Conversion and to Restricted Closures</span><br/>
<span class="as">by Howard Lovatt</span><br/>
<span class="pd">January 2, 2008</span><br/>
</br></div>
<blockquote>
<b>Summary</b><br/>
The Closure proposal from Neal Gafter et al. introduces something that is like an object, a closure, but not quite. To enable interoperation with normal objects a form of autoboxing is used, this autoboxing has two forms, normal closure conversion and restricted closure conversion. This blog examines an alternative.

</blockquote>
<hr align="left" width="90%"/>
<table align="right">
<tr>
<td>
<div class="adnotice">
Advertisement
</div>
<center>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
if (!document.phpAds_used) document.phpAds_used = ',';
phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
document.write ("&amp;what=zone:2");
document.write ("&amp;exclude=" + document.phpAds_used);
if (document.referrer)
document.write ("&amp;referer=" + escape(document.referrer));
document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a74ab060.html" target="_blank"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:2&amp;n=a74ab060.html"/></a></noscript>
</center>
</td>
</tr>
</table>
<p>
<h1>Disclosure and Gripe</h1>
<p>I should begin by disclosing that I have presented an alternative to the <a href="../_/http/www.javac.info/closures-v05.html">closures</a> proposal, <a href="../_/http/www.artima.com/weblogs/viewpost.html$/thread=182412.html">C3S</a> that is based on objects. So obviously I don't whole heartedly agree with the closures proposal as it stands. However I would like a shorter syntax for creating one off instances of interfaces and classes.</p>
<p>Now the gripe: I have tried to have a discussion about alternatives to the BGGA proposal on Neal's blog. Neal chooses to moderate his blog and what typically happens is that I make a comment, which he allows, then he replies with a rebuttal, I disagree with the rebuttal and post a second comment. This second comment is then moderated. I am not sure if Neal is doing this deliberately or not, but either way the result appears that a question was raised and addressed and the issue has gone away. From my point of view this is far from the truth. The issue of this blog, closure conversions, is one such case and hence my own blog entry.</p>
<p>I have invited Neal to have a right of reply and I sincerely hope he does state how he sees the moderating of comments on his blog.</p>
<p>As an aside: an un-moderated blog has the advantage of providing a record of discussions. With a moderated blog you can never be certain that you are seeing the 'whole truth'.</p>
<h1>Closure Conversion</h1>
<p>Closures are structurally typed not name typed, for example suppose you had a military application:</p>
<pre>
interface Missile { boolean fire( long timeInMS ); }
interface Ship { boolean depart( long timeInMS ); }
</pre>
<p>You have two distinct methods with different names <code>Missile.fire</code> and <code>Ship.depart</code>, even though they have the same signature <code>boolean <i>xxx</i>( long )</code>. With a closure there are no names so a closure with the right signature can gets converted via a closure conversion to either of these:</p>
<pre>
Missile m = { long timeInMS =&gt; ... }; // closure get boxed into a Missile
Ship s = { long timeInMS =&gt; ... }; // closure gets boxed into a Ship
</pre>
<p>Note a closure only gets converted once, i.e. you can't say <code>s = m</code> and if you say <code>{ long =&gt; void } c = { long timeInMS =&gt; ... }</code> then a closure conversion to a synthetic interface goes on behind the scenes and hence you can't say <code>m = c</code>. This automatic boxing is necessary to allow interoperation of closures with interfaces. Closure conversion only works with interfaces that have exactly one method. If there are two methods, or if there is a class then there are no closure conversions. Therefore not all existing APIs can be use <i>directly</i> with closures via closure conversions, e.g. AWT and Swing: <code>AbstractAction</code>, <code>MouseListener</code>, <code>KeyListener</code>, etc. There are some suitable interfaces in AWT like <code>ActionListener</code>, but it is annoying that it is not universally possible to use a closure to define abstract methods.</p>
<h1>Restricted Closure Conversion</h1>
<p>So what's the problem other than incompatible existing APIs? Well if the closure is stored somewhere and then executed at a later time there are a number of features that don't work. Closures allow non-local returns, for example. If an <code>each</code> method were added to <code>java.util.Collections</code> then:<p>
<pre>
static &lt;T&gt; boolean isKeyPresent( List&lt;T&gt; list, T key ) {
  Collections.each( list, {T x =&gt; if ( x.equals( key ) ) return true; } );
  return false;
}
</pre>
<p><i><small>There is an alternative syntax for things like <code>each</code> methods, but to keep this blog simple I didn't use that syntax in the above example.</small></i></p>
<p>The <code>return</code> statement inside the closure not only returns from the closure but also from the enclosing method, <code>isKeyPresent</code>.</p>
<p>Now if a closure is to be executed after it is made then an exception can result when the code is run, e.g. if a closure is passed to another thread, stored in a data structure for execution later, or made by another method:</p>
<pre>
static { =&gt; void } makeMethod() {
  return { =&gt;
    ...
    return { =&gt; ...; }; // Error not caught by the compiler! Returns from makeMethod and the closure
  };
}

static void main( String[] notUsed ) { makeMethod().invoke(); }
</pre>
<p>This is an error since the <code>return</code> inside the closure inside <code>makeMethod</code> tries to return from <code>makeMethod</code> (and the closure) but the closure is executed inside <code>main</code>, not inside <code>makeMethod</code>, and hence the code throws an exception when run. <i>The above example is an error — the <code>return</code> keyword should be omitted inside the closure (but with an inner class you would need the return and therefore this is likely to be a common error since people will have to mix closures with inner classes).</i></p>
<p>To try and prevent these exceptions occurring a marker interface, <code>RestrictedFunction</code>, can be used to mark an interface but not the closure. Therefore if the above example is rewritten to introduce an interface the error can be prevented:</p>
<pre>
interface VoidMethod extends RestrictedFunction { void invoke(); }

static VoidMethod makeMethod() {
  return { =&gt;
    ...
    return { =&gt; ...; }; // Error now caught by the compiler
  };
}
</pre>
<p>But to prevent the error you need to modify interfaces to extend <code>RestrictedFunction</code> and this may not be possible if you don't control all the source, i.e. you will be relying on all the Java libraries, including third party, to be modified to be closure compatible.</p>
<h1>An Alternative</h1>
<p>An alternative to <code>RestrictedFunction</code> is given in <a href="../_/http/www.artima.com/weblogs/viewpost.html$/thread=182412.html">C3S</a> and is to make a closure a normal object that behaves like an instance of an inner class and for the special features, like non-local returns, to require named qualification, e.g. the examples above:</p>
<pre>
static { =&gt; void } makeMethod() {
  return { =&gt;
    ...
    return { =&gt; ...; }; // Error! The closure returns a void
  };
}
</pre>
<p>or</p>
<pre>
static { =&gt; void } makeMethod() {
  return { =&gt;
    ...
    makeMethod.return { =&gt; ...; };
  }; // Error non-local return used inside an un-executed closure
}
</pre>
<p>and</p>
<pre>
static &lt;T&gt; boolean isKeyPresent( List&lt;T&gt; list, T key ) {
  Collections.each( list, {
    T x =&gt; if ( x.equals( key ) ) isKeyPresent.return true; // Qualified return
  } );
  return false;
}
</pre>
<p>I.E. explicitly say what is to be returned from if it isn't the immediately enclosing scope.</p>
<p>For name scoping retain the current inner class rules, i.e. if a name is inherited and also exists in an outer scope then the inherited name takes precedence and the outer scope name needs to be qualified. The only inherited names in a closure are method names from <code>Object</code> and the method name <code>invoke</code>, therefore name clashes will be rare. If from within a closure you wanted to refer to the enclosing classes <code>toString</code> method, for example, then just like an inner class you would write <code><i>[class name]</i>.toString()</code>.</p>
<h2>Tennent's Correspondence Principle</h2>
<p>Neal Gafter, one of the proposers of closures for Java, has suggested that Tennent's Correspondence Principle is applied to design closures. Tennent mostly demonstrated his principle by enclosing some code inside an inner procedure (void method in Java speak). The principle is that if you enclose an expression inside an inner procedure and execute the procedure then the meaning of the expression shouldn't change. This principle precludes the return statement and is therefore problematic to apply to Java closure proposals since Java already has return. In Java you can't have inner methods but if you could then:</p>
<pre>
int outer() {
  return 1; // Expression to be enclosed
}
</pre>
<p>Then enclose the statement in an inner method and execute the method (assuming Java had inner methods):</p>
<pre>
int outer() {
  void inner() { return 1; } // Error! inner is a void method
  inner();
} // Error outer doesn't return a value
</pre>
<p>The solution from Tennent is to ban return statements and have the name of the method as the return value, e.g.:</p>
<pre>
int outer() {
  outer = 1; // Expression to be enclosed (equivalent of return)
}
</pre>
<p>Becomes:</p>
<pre>
int outer() {
  void inner() { outer = 1; } // OK
  inner();
} // OK outer is 1
</pre>
<p>With name qualified returns it is better than standard Java unqualified return, though far from perfect:</p>
<pre>
int outer() {
  void inner() { outer.return 1; } // OK
  inner();
  return 0; // Dummy return to keep compiler happy
}
</pre>
<p>Therefore named returns help, but are not perfect. Surprisingly, considering that Tennent's Principle is often quoted when discussing closures, the present closure proposal has the same problem as named returns:</p>
<pre>
int outer() {
  { =&gt; return 1; }.invoke();
  return 0; // Dummy return to keep compiler happy
}
</pre>
<p>The compiler cannot in general follow control flow inside the closure and therefore cannot prove that <code>outer</code> always returns a value (at least for complex closures — unlike the example which the compiler may be able to do).</p>
<h1>Summary</h1>
<p>Closure conversions, both normal and restricted, have a number of catches, a bit like autoboxing of primitives does. The problem is that a closure, like a primitive, is a bit like an object but not quite and this difference is patched over by boxing the closure within an object. I think we should be striving for a more consistency, i.e. everything as an object, not introducing more none-object types.</p>
<p>I have presented an alternative that retains the power of the closure but without the downside, in particular I have presented a closure that <i>is</i> an object and therefore doesn't require any boxing. What do others think?</p>
<h1>Talk Back!</h1>
<p>
Have an opinion?


Readers have already posted

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=220920.html">30

comments</a>
about this weblog entry. Why not

<a href="../_/https/www.artima.com/forums/post.html$/forum=106&amp;thread=220920&amp;reply=true.html">add yours</a>?


<h1>RSS Feed</h1>
<p>
If you'd like to be notified whenever Howard Lovatt adds a new entry to <a href="../index.html$/blogger=hlovatt.html">his weblog</a>, subscribe to his <a href="../feeds/bloggers/hlovatt.rss">RSS feed</a>.

<center>
<div class="sociallinks">
<a href="../_/http/digg.com/submit$/phase=2&amp;url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D220920&amp;title=An+Alternative+to+Closure+Conversion+and+to+Restricted+Closures&amp;bodytext=The+Closure+proposal+from+Neal+Gafter+et+al.+introduces+something+that+is+like+an+object%2C+a+closure%2C+but+not+quite.+To+enable+interoperation+with+normal+objects+a+form+of+autoboxing+is+used%2C+this+autoboxing+has+two+forms%2C+normal+closure+conversion+and+_&amp;topic=programming">
<img alt="Digg" border="0" height="14" hspace="8" src="../_/https/www.artima.com/images/digg.gif" width="16">Digg
  </img></a>
  |
  <a href="../_/http/del.icio.us/post$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D220920&amp;title=An+Alternative+to+Closure+Conversion+and+to+Restricted+Closures">
<img alt="del.icio.us" border="0" height="16" hspace="8" src="../_/https/www.artima.com/images/delicious.gif" vspace="1" width="16">del.icio.us
  </img></a>
  |
  <a href="../_/http/programming.reddit.com/submit$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D220920&amp;title=An+Alternative+to+Closure+Conversion+and+to+Restricted+Closures">
<img alt="Reddit" border="0" height="18" hspace="8" src="../_/https/www.artima.com/images/reddit.gif" width="18"/>Reddit
  </a>
</div>
</center>
<h1>About the Blogger</h1>
<p>
<table><tr valign="bottom"><td><img align="right" src="../_/https/www.artima.com/images/howardlovatt.jpg"/></td><td>Dr. Howard Lovatt is a senior scientist with CSIRO, an Australian government owned research organization, and is the creator of the <a href="../_/https/pec.dev.java.net/nonav/frontpage.html">Pattern Enforcing Compiler</a> (PEC) for Java. PEC is an extended Java compiler that allows Software Design Patterns to be declared and hence checked by the compiler. PEC forms the basis of Howard's 2nd PhD, his first concerned the design of Switched Reluctance Motors.</td></tr></table><p>
<div class="sp">This weblog entry is Copyright © 2008 Howard Lovatt. All rights reserved.</div>
</p></p></p></p></p></p></p></div>

<hr width="100%">
<table align="center" width="50%">
<tr>
<td>
<div class="horizontaltextadbox">
<div class="adheadline">Sponsored Links</div>
<div id="sponsoredlinks">
</div>
</div>
</td>
</tr>
</table>
<hr width="100%"/>
<center>
<script type="text/javascript"><!--
google_ad_client = "pub-3911176865765226";
google_alternate_color = "ffffff";
google_ad_width = 728;
google_ad_height = 15;
google_ad_format = "728x15_0ads_al";
google_ad_channel = "";
google_color_border = "ffffff";
google_color_bg = "FFFFFF";
google_color_link = "003090";
google_color_text = "000000";
google_color_url = "666666";
//--></script>
<script src="../_/https/pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
</script>
<br>
<br/>
<!-- SiteSearch Google -->
<form action="../_/https/www.google.com/custom/index.html" method="get">
<table bgcolor="#ffffff" border="0">
<tr><td align="left" height="32" nowrap="nowrap" valign="top">
<a href="../_/https/www.google.com/index.html">
<img alt="Google" border="0" src="../_/https/www.google.com/logos/Logo_25wht.gif"/></a>
</td>
<td nowrap="nowrap">
<input name="domains" type="hidden" value="Artima.com"/>
<input maxlength="255" name="q" size="31" type="text" value=""/>
<input name="sa" type="submit" value="Search"/>
</td></tr>
<tr>
<td> </td>
<td nowrap="nowrap">
<font color="#000000" size="-1">
<input name="sitesearch" type="radio" value=""/> Web
<input checked="checked" name="sitesearch" type="radio" value="Artima.com"/>Artima.com
</font>  
<input name="client" type="hidden" value="pub-3911176865765226"/>
<input name="forid" type="hidden" value="1"/>
<input name="ie" type="hidden" value="ISO-8859-1"/>
<input name="oe" type="hidden" value="ISO-8859-1"/>
<input name="cof" type="hidden" value="GALT:#008000;GL:1;DIV:#336699;VLC:663399;AH:center;BGC:FFFFFF;LBGC:FFFFFF;ALC:0000FF;LC:0000FF;T:000000;GFNT:0000FF;GIMP:0000FF;LH:50;LW:150;L:https://www.artima.com/images/artima150.gif;S:https://www.artima.com;FORID:1;"/>
<input name="hl" type="hidden" value="en"/>
</td></tr></table>
</form>
<!-- SiteSearch Google -->
</br></center>
<br/>
<div class="sp">
<div style="text-align: center;">
<a href="../_/https/www.artima.com/copyright.html">Copyright</a> © 1996-2019 Artima, Inc. All Rights Reserved. - <a href="../_/https/www.artima.com/privacy.html">Privacy Policy</a> - <a href="../_/https/www.artima.com/termsofuse.html">Terms of Use</a>
</div>
</div>
<br/>
<script language="JavaScript" type="text/javascript">
<!--
function initBannerVarForZone(zone) {
        initBannerVarForZoneWithScript(zone, 'adjs_modified');
}

function initBannerVarForZoneWithScript(zone, phpScript) {

        if (!document.phpAds_used) document.phpAds_used = ',';
        phpAds_random = new String (Math.random());
        phpAds_random = phpAds_random.substring(2,11);

        var nextScriptSrc = '../_/https/www.artima.com/zcr/index.html' + phpScript + '.php?n=' +
                phpAds_random  +
                '&amp;what=zone:' + zone + '&amp;target=_top&amp;block=1&amp;blockcampaign=1' +
                '&amp;exclude=' + document.phpAds_used;

        document.write("<script language='JavaScript' type='text/javascript' src='");
        document.write(nextScriptSrc);
        document.write("'><\/script>");

}

function replaceDiv(divID) {
        document.getElementById(divID).innerHTML = phpadsbanner;
}
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZone(3);
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('leftskyscraper');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZoneWithScript(4, 'textman');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('sponsoredlinks');
-->
</script>
</hr><a href="https://dafoster.net/projects/crystal-web-archiver/" id="cr-footer-banner" style="border-top: 2px #B40010 solid;background: #FFFAE1;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;font-variant: initial;font-weight: initial;text-transform: none;font-size: 14px;color: #6c757d;line-height: 2.0;cursor: pointer;display: flex;align-items: center;justify-content: center;gap: 4px;clear: both;" target="_blank"><img height="24" onerror="this.style['display'] = 'none';" src="../_/crystal/resources/appicon.png" width="24"/><span>This page was archived with Crystal</span><script>window.addEventListener('load', function() { const $1 = document.querySelector('#cr-footer-banner'); if (!$1) { return; } if (window !== window.top) { let $2 = false; if (window.name) { const $3 = window.parent.document.getElementsByName(window.name); if ($3.length === 1) { const $4 = $3[0]; if ($4.tagName === 'FRAME' && $4.parentElement.tagName === 'FRAMESET') { let $5 = $4; while (true) { if ($5.parentElement.tagName !== 'FRAMESET') { $2 = true; break; } if ($5.parentElement.attributes['rows'] !== undefined) { const $6 = $5.parentElement.children; if ($5 === $6[$6.length - 1]) { $5 = $5.parentElement; continue; } else { break; } } else if ($5.parentElement.attributes['cols'] !== undefined) { const $7 = Array.from($5.parentElement.children); const $8 = $7.indexOf($5); if ($8 === -1) { break; } const $9 = $5.parentElement.attributes['cols'].value.split(','); const $10 = $9.map((s) => parseInt(s.trim())); if ($9[$8].trim() === '*' || $10[$8] === Math.max.apply(null, $10)) { $5 = $5.parentElement; continue; } else { break; } } else { break; } } } } } if (!$2) { $1.style['display'] = 'none'; } } const $11 = $1.getBoundingClientRect(); const $12 = ($11.y < window.innerHeight - $11.height); if ($12) { $1.style['position'] = 'fixed'; $1.style['bottom'] = '0'; $1.style['left'] = '0'; $1.style['right'] = '0'; $1.style['z-index'] = '9999'; } const $13 = ( document.body.getBoundingClientRect().height < $11.height * 2 ); if ($13) { $1.style['display'] = 'none'; }
});</script></a></body>
</html>
