
<!DOCTYPE html>

<html>
<head><meta content="noindex,nofollow" name="robots"/>
<title>New Control Structures for Java</title>
<meta charset="utf-8"/>
<meta content="Howard Lovatt" name="author">
<link href="../_/https/www.artima.com/artima.css" rel="stylesheet" type="text/css"/>
<link href="../_/https/www.artima.com/favicon.ico" rel="shortcut icon"/>
</meta></head>
<body><table cellspacing="0" width="100%">
<tr>
<td align="left" valign="bottom">
<a href="../_/https/www.artima.com/index.html"><img alt="The Artima Developer Community" border="0" height="43" src="../_/https/www.artima.com/images/a7.gif" width="550"/></a>
</td>
</tr></table>
<table bgcolor="#333333" width="100%">
<tr>
<td align="center">
<div class="ml">
<a class="hl" href="../_/https/www.artima.com/articles/index.html">Articles</a> |
<a class="hl" href="../_/https/www.artima.com/news/index.html">News</a> |
<a class="hl" href="../index.html">Weblogs</a> |
<a class="hl" href="../_/https/www.artima.com/shop/catalog/index.html">Books</a> |
<a class="hl" href="../_/https/www.artima.com/forums/index.html">Forums</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#CCCCCC" width="100%">
<tr>
<td align="center">
<div class="sc">
<a href="../index.html">Artima Weblogs</a> | 

<a href="../index.html$/blogger=hlovatt.html">Howard Lovatt's Weblog</a> | 

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=240412.html">Discuss</a> | 
<a href="mailto:?subject=New Control Structures for Java&amp;body= %0AArtima Weblogs %0ANew Control Structures for Java %0Aby Howard Lovatt %0A%0Ahttps://www.artima.com/weblogs/viewpost.jsp?thread=240412">Email</a> | 
<a href="../viewpostP.html$/thread=240412.html">Print</a> | 
<a href="../bloggers.html">Bloggers</a> | 
<a class="sl" href="thread=222021.html" title="Simplyfing Java Generics by Eliminating Wildcards">Previous</a> | 
<a class="sl" href="thread=277879.html" title="Reified Lambda Functions">Next</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#EEEEEE" width="100%">
<tr>
<td align="center">
<div class="sc">
<span style="color: #555555;">Sponsored Link</span> <span style="color: #888888;">•</span>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
   if (!document.phpAds_used) document.phpAds_used = ',';
   phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
   
   document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
   document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
   document.write ("&amp;what=zone:9&amp;target=_top");   document.write ("&amp;exclude=" + document.phpAds_used);
   if (document.referrer)
      document.write ("&amp;referer=" + escape(document.referrer));
   document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a799ecf6.html" target="_top"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:9&amp;n=a0587811.html"/></a></noscript>
</div>
</td>
</tr>
</table>
<br/>
<div class="vegies">
<div class="tc">
<span class="sts">Pattern Centric Blog</span><br>
<span class="ts">New Control Structures for Java</span><br/>
<span class="as">by Howard Lovatt</span><br/>
<span class="pd">October 15, 2008</span><br/>
</br></div>
<blockquote>
<b>Summary</b><br/>
Java has many traditional control structures, like if and for. There are also proposals, BGGA, JCA, and ARM, to add more. This post examines what new structures might be of interest and suggests that more traditional control structures would add little and instead parallel-functional structures would be more useful.

</blockquote>
<hr align="left" width="90%"/>
<table align="right">
<tr>
<td>
<div class="adnotice">
Advertisement
</div>
<center>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
if (!document.phpAds_used) document.phpAds_used = ',';
phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
document.write ("&amp;what=zone:2");
document.write ("&amp;exclude=" + document.phpAds_used);
if (document.referrer)
document.write ("&amp;referer=" + escape(document.referrer));
document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a74ab060.html" target="_blank"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:2&amp;n=a74ab060.html"/></a></noscript>
</center>
</td>
</tr>
</table>
<p>
<p>
This post is primarily about the semantics of control structures and inner classes/closures, but also discusses some syntax aspects. Traditional control structures are constructs like <code>if</code> and <code>for</code> that are found in many languages, for example Java's are almost identical to C's. Traditional control structures are characterised by:
</p>
<ol>
<li>Not having a return value; they are statements rather than expressions.
  <li>The code blocks to be executed do not have arguments; instead new or existing variables are used (e.g. in "<code>for ( int i = ... )</code>" <code>i</code> is a new variable)
  <li>Sequential in nature; <code>for</code> evaluates each loop in turn.
</li></li></li></ol>
<p>
The only non traditional control structure that Java has is <code>?:</code>, which does return a value. Proposals to extend Java like <a href="../_/http/www.javac.info/closures-v05.html">BGGA</a> and <a href="../_/http/docs.google.com/View$/docid=ddhp95vd_0f7mcns/index.html">FCM + JCA</a> suggest adding the ability to write more traditional control structures. In fact this is a major driver for the BGGA proposal which ends up limiting the power of a BGGA closure itself so that it can be used in a traditional control structure and also means that two types of closure are required, a restricted closure and an unrestricted closure. There may be a case for some extra traditional control structures, e.g. a <code>for</code> each loop with an index or <a href="../_/http/docs.google.com/View$/docid=dffxznxr_1nmsqkz/index.html">Automatic Resource Management (ARM)</a>, but I say that traditional structures are already well covered.
</p>
<p>
Other newer languages emphasise parallel control structures and control structures that return a value, e.g. <a href="../_/http/projectfortress.sun.com/Projects/Community/index.html">Fortress</a>. Newer languages emphasise parallel-functional programming because this is easier on multi-core machines that are now commonplace. What I would like is the ability to write these new control structures. The inner class construct provides the ideal basis for writing parallel-functional structures. Consider a <code>forEach</code> loop that has an index, executes each loop in parallel, and returns the results as a map associating index with returned value.
</p>
<pre>
  <i>public static abstract class</i> ForEach&lt;O, K, I&gt; {
    <i>protected static final</i> Exception CONTINUE = <i>new</i> Exception( <i>"forEach Continue"</i> );
    <i>static</i> { CONTINUE.setStackTrace( <i>new</i> StackTraceElement[ 0 ] ); } <i>// Delete irrelevant stack trace</i>

    <i>public abstract</i> O block( K index, I in ) <i>throws</i> Exception;

    Callable&lt;O&gt; aLoop( final K index, final I in ) {
      <i>return new</i> Callable&lt;O&gt;() {
        <i>public</i> O call() <i>throws</i> Exception { <i>return</i> block( index, in ); }
      };
    }
  }

  <i>public static</i> &lt;O, K, I&gt; LinkedHashMap&lt;K, O&gt; forEach( <i>final</i> ExecutorService pool,
                                                       <i>final</i> Map&lt;K, I&gt; in,
                                                       <i>final</i> ForEach&lt;O, K, I&gt; block ) {
    <i>final int</i> size = in.size();
    <i>final</i> Map&lt;K, Future&lt;O&gt;&gt; futures = <i>new</i> LinkedHashMap&lt;K, Future&lt;O&gt;&gt;( size );
    <i>for</i> ( <i>final</i> Map.Entry&lt;K, I&gt; entry : in.entrySet() ) { <i>// Execute in parallel</i>
      <i>final</i> K index = entry.getKey();
      <i>final</i> Callable&lt;O&gt; oneLoop = block.aLoop( index, entry.getValue() );
      <i>final</i> Future&lt;O&gt; future = pool.submit( oneLoop );
      futures.put( index, future );
    }

    <i>final</i> LinkedHashMap&lt;K, O&gt; results = <i>new</i> LinkedHashMap&lt;K, O&gt;( size );
    <i>for</i> ( <i>final</i> Map.Entry&lt;K, Future&lt;O&gt;&gt; entry : futures.entrySet() ) { <i>// Collect results</i>
      <i>final</i> K index = entry.getKey();
      <i>try</i> {
        results.put( index, entry.getValue().get() );
      } <i>catch</i> ( ExecutionException e ) {
        <i>final</i> Throwable cause = e.getCause();
        <i>if</i> ( cause != ForEach.CONTINUE ) { <i>// Ignore CONTINUE otherwise abort</i>
          <i>for</i> ( <i>final</i> Future&gt;O&gt; f : futures.values() ) { f.cancel( <i>true</i> ); }
          <i>throw new</i> IllegalStateException( <i>"Exception thrown when evaluating forEach block index "</i> +
                                           index + <i>" of value "</i> +
                                           in.get( index ), cause );
        } 
      } <i>catch</i> ( CancellationException e ) { <i>// Ignore cancelled result</i>
      } <i>catch</i> ( InterruptedException e ) {
        Thread.currentThread().interrupt(); <i>// Restore the interrupted status</i>
      }
    }

    <i>return</i> results;
  }
</pre>
<p>
Which is executed like this:
</p>
<pre>
  <i>final int</i> numProc = 2 * Runtime.getRuntime().availableProcessors();
  <i>final</i> ExecutorService pool = Executors.newFixedThreadPool( numProc );
  <i>final</i> String text = <i>"*Hello*"</i>;
  <i>final int</i> size = text.length();
  <i>final</i> Map&lt;Integer, Character&gt; input = <i>new</i> LinkedHashMap&lt;Integer, Character&gt;( size );
  <i>for</i> ( <i>int</i> i = 0; i &lt; size; i++ ) { input.put( i, text.charAt(i) ); }

  <i>final</i> <b>ForEach</b>&lt;Character, Integer, Character&gt; <b>trim</b> = <i>new</i> <b>ForEach</b>&lt;Character, Integer, Character&gt;() {
    <i>public</i> Character <b>block</b>( <i>final</i> Integer index, <i>final</i> Character in ) <i>throws</i> Exception {
      <i>if</i> ( index &lt;= 0 || index &gt;= size - 1 ) { <i>throw</i> <b>CONTINUE</b>; }
      <i>return</i> in;
    }
  };
  <i>final</i> Map&lt;Integer, Character&gt; output = <b>forEach</b>( pool, input, <b>trim</b> );

  out.println( output );
  pool.shutdownNow();
</pre>
<p>
and gives the expected result:
</p>
<pre>
  {1=H, 2=e, 3=l, 4=l, 5=o}
</pre>
<p>
The important thing demonstrated is that inner classes have the ideal semantics for parallel-functional structures, but not the ideal syntax (see below). The semantics of the BGGA style closures are not ideal for this type of control structure because you need to use a restricted closure (not an unrestricted) and you have to be careful not to inadvertently box this closure inappropriately (e.g. into a function type). The scope of variables etc. is not ideal with a BGGA style closure either. This is not to say that something similar cannot be written in BGGA, just to say that it will be worse than what we can currently write. This begs the question of why add a BGGA style closure when the existing inner classes are better. The BGGA and JCA proposals also have further syntax support for calling control structures, but unfortunately this can only be used with traditional control structures.
</p>
<p>
As mentioned above, there are some syntax improvements that can be made in terms of calling the new control structure, <code>forEach</code>. The declaration of the <code>forEach</code> method itself could also be shorter; but since the method is called more often than it is written, this is less important. The inner class <code>trim</code>, that is the block of code executed in parallel by <code>forEach</code>, is the main area where syntax improvements can be made. All the inner class/closure proposals, <a href="../_/http/www.artima.com/weblogs/viewpost.html$/thread=182412.html">C3S</a> (this is my suggestion!), <a href="../_/http/docs.google.com/View$/docid=k73_1ggr36h&amp;/index.html">CICE</a>, BGGA, and FCM, all provide shorter syntax for inner classes/closures, e.g. using C3S syntax the call to <code>forEach</code> and the inner class <code>trim</code> could be written in one line as:
</p>
<pre>
  <i>final</i> Map&lt;Integer, Character&gt; output = forEach( pool, input, <b><i>method</i></b>( index, in ) {
    <i>if</i> ( index &lt;= 0 || index &gt;= size - 1 ) { <i>throw</i> CONTINUE; }
    <i>return</i> in;
  } );
</pre>
<p>
The primary syntax support provided by C3S is the keyword <code>method</code> that makes an instance of an anonymous class and overrides the only abstract method in its super class and also infers the super-class type, method to be overridden, argument types, return type, and exception types. This short syntax for defining an inner-class instance helps a great deal with the readability of the code and I think some form of short syntax for inner classes would be a useful addition to Java.
</p>
<p>
C3S also provides further, <i>secondary</i>, syntax support and the line can be written as:
</p>
<pre>
  <i>final</i> output = forEach pool, input, <i>method</i>( index, in ) {
    <i>if</i> ( index &lt;= 0 || index &gt;= size - 1 ) { <i>throw</i> CONTINUE }
    in
  };
</pre>
<p>
This secondary syntax support provided by C3S is:
</p>
<ol>
<li>Infers the type of <code>output</code>
<li>Brackets, (), are not needed for method calls provided that it is not ambiguous.
  <li>The semicolon before a close brace, }, is not needed.
  <li><code>return</code> is optional at the end of a method.
</li></li></li></li></ol>
<p>
I think this extra secondary support for inner classes and method calling is worth having, but the gain is not as great as that provided by short syntax for inner-class instances.
</p>
<p>
This post has demonstrated that the ideal semantics for new control structures are those of the inner class and that the BGGA and JCA proposals do not give us a useful new construct because they are biased both in terms of their closure semantics and syntactic support to traditional control structures. Java has a good selection of tradition control structures and I contend that what is really needed is the ability to write parallel-functional control structures; further I suggest that inner classes with shorter syntax are ideal for this purpose, perhaps with further short syntax for calling these structures. What do you think?
</p>
<h1>Talk Back!</h1>
<p>
Have an opinion?


Readers have already posted

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=240412.html">32

comments</a>
about this weblog entry. Why not

<a href="../_/https/www.artima.com/forums/post.html$/forum=106&amp;thread=240412&amp;reply=true.html">add yours</a>?


<h1>RSS Feed</h1>
<p>
If you'd like to be notified whenever Howard Lovatt adds a new entry to <a href="../index.html$/blogger=hlovatt.html">his weblog</a>, subscribe to his <a href="../feeds/bloggers/hlovatt.rss">RSS feed</a>.

<center>
<div class="sociallinks">
<a href="../_/http/digg.com/submit$/phase=2&amp;url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D240412&amp;title=New+Control+Structures+for+Java&amp;bodytext=Java+has+many+traditional+control+structures%2C+like+if+and+for.+There+are+also+proposals%2C+BGGA%2C+JCA%2C+and+ARM%2C+to+add+more.+This+post+examines+what+new+structures+might+be+of+interest+and+suggests+that+more+traditional+control+structures+would+add+_&amp;topic=programming">
<img alt="Digg" border="0" height="14" hspace="8" src="../_/https/www.artima.com/images/digg.gif" width="16">Digg
  </img></a>
  |
  <a href="../_/http/del.icio.us/post$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D240412&amp;title=New+Control+Structures+for+Java">
<img alt="del.icio.us" border="0" height="16" hspace="8" src="../_/https/www.artima.com/images/delicious.gif" vspace="1" width="16">del.icio.us
  </img></a>
  |
  <a href="../_/http/programming.reddit.com/submit$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D240412&amp;title=New+Control+Structures+for+Java">
<img alt="Reddit" border="0" height="18" hspace="8" src="../_/https/www.artima.com/images/reddit.gif" width="18"/>Reddit
  </a>
</div>
</center>
<h1>About the Blogger</h1>
<p>
<table><tr valign="bottom"><td><img align="right" src="../_/https/www.artima.com/images/howardlovatt.jpg"/></td><td>Dr. Howard Lovatt is a senior scientist with CSIRO, an Australian government owned research organization, and is the creator of the <a href="../_/https/pec.dev.java.net/nonav/frontpage.html">Pattern Enforcing Compiler</a> (PEC) for Java. PEC is an extended Java compiler that allows Software Design Patterns to be declared and hence checked by the compiler. PEC forms the basis of Howard's 2nd PhD, his first concerned the design of Switched Reluctance Motors.</td></tr></table><p>
<div class="sp">This weblog entry is Copyright © 2008 Howard Lovatt. All rights reserved.</div>
</p></p></p></p></p></div>

<hr width="100%">
<table align="center" width="50%">
<tr>
<td>
<div class="horizontaltextadbox">
<div class="adheadline">Sponsored Links</div>
<div id="sponsoredlinks">
</div>
</div>
</td>
</tr>
</table>
<hr width="100%"/>
<center>
<script type="text/javascript"><!--
google_ad_client = "pub-3911176865765226";
google_alternate_color = "ffffff";
google_ad_width = 728;
google_ad_height = 15;
google_ad_format = "728x15_0ads_al";
google_ad_channel = "";
google_color_border = "ffffff";
google_color_bg = "FFFFFF";
google_color_link = "003090";
google_color_text = "000000";
google_color_url = "666666";
//--></script>
<script src="../_/https/pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
</script>
<br>
<br/>
<!-- SiteSearch Google -->
<form action="../_/https/www.google.com/custom/index.html" method="get">
<table bgcolor="#ffffff" border="0">
<tr><td align="left" height="32" nowrap="nowrap" valign="top">
<a href="../_/https/www.google.com/index.html">
<img alt="Google" border="0" src="../_/https/www.google.com/logos/Logo_25wht.gif"/></a>
</td>
<td nowrap="nowrap">
<input name="domains" type="hidden" value="Artima.com"/>
<input maxlength="255" name="q" size="31" type="text" value=""/>
<input name="sa" type="submit" value="Search"/>
</td></tr>
<tr>
<td> </td>
<td nowrap="nowrap">
<font color="#000000" size="-1">
<input name="sitesearch" type="radio" value=""/> Web
<input checked="checked" name="sitesearch" type="radio" value="Artima.com"/>Artima.com
</font>  
<input name="client" type="hidden" value="pub-3911176865765226"/>
<input name="forid" type="hidden" value="1"/>
<input name="ie" type="hidden" value="ISO-8859-1"/>
<input name="oe" type="hidden" value="ISO-8859-1"/>
<input name="cof" type="hidden" value="GALT:#008000;GL:1;DIV:#336699;VLC:663399;AH:center;BGC:FFFFFF;LBGC:FFFFFF;ALC:0000FF;LC:0000FF;T:000000;GFNT:0000FF;GIMP:0000FF;LH:50;LW:150;L:https://www.artima.com/images/artima150.gif;S:https://www.artima.com;FORID:1;"/>
<input name="hl" type="hidden" value="en"/>
</td></tr></table>
</form>
<!-- SiteSearch Google -->
</br></center>
<br/>
<div class="sp">
<div style="text-align: center;">
<a href="../_/https/www.artima.com/copyright.html">Copyright</a> © 1996-2019 Artima, Inc. All Rights Reserved. - <a href="../_/https/www.artima.com/privacy.html">Privacy Policy</a> - <a href="../_/https/www.artima.com/termsofuse.html">Terms of Use</a>
</div>
</div>
<br/>
<script language="JavaScript" type="text/javascript">
<!--
function initBannerVarForZone(zone) {
        initBannerVarForZoneWithScript(zone, 'adjs_modified');
}

function initBannerVarForZoneWithScript(zone, phpScript) {

        if (!document.phpAds_used) document.phpAds_used = ',';
        phpAds_random = new String (Math.random());
        phpAds_random = phpAds_random.substring(2,11);

        var nextScriptSrc = '../_/https/www.artima.com/zcr/index.html' + phpScript + '.php?n=' +
                phpAds_random  +
                '&amp;what=zone:' + zone + '&amp;target=_top&amp;block=1&amp;blockcampaign=1' +
                '&amp;exclude=' + document.phpAds_used;

        document.write("<script language='JavaScript' type='text/javascript' src='");
        document.write(nextScriptSrc);
        document.write("'><\/script>");

}

function replaceDiv(divID) {
        document.getElementById(divID).innerHTML = phpadsbanner;
}
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZone(3);
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('leftskyscraper');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZoneWithScript(4, 'textman');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('sponsoredlinks');
-->
</script>
</hr><a href="https://dafoster.net/projects/crystal-web-archiver/" id="cr-footer-banner" style="border-top: 2px #B40010 solid;background: #FFFAE1;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;font-variant: initial;font-weight: initial;text-transform: none;font-size: 14px;color: #6c757d;line-height: 2.0;cursor: pointer;display: flex;align-items: center;justify-content: center;gap: 4px;clear: both;" target="_blank"><img height="24" onerror="this.style['display'] = 'none';" src="../_/crystal/resources/appicon.png" width="24"/><span>This page was archived with Crystal</span><script>window.addEventListener('load', function() { const $1 = document.querySelector('#cr-footer-banner'); if (!$1) { return; } if (window !== window.top) { let $2 = false; if (window.name) { const $3 = window.parent.document.getElementsByName(window.name); if ($3.length === 1) { const $4 = $3[0]; if ($4.tagName === 'FRAME' && $4.parentElement.tagName === 'FRAMESET') { let $5 = $4; while (true) { if ($5.parentElement.tagName !== 'FRAMESET') { $2 = true; break; } if ($5.parentElement.attributes['rows'] !== undefined) { const $6 = $5.parentElement.children; if ($5 === $6[$6.length - 1]) { $5 = $5.parentElement; continue; } else { break; } } else if ($5.parentElement.attributes['cols'] !== undefined) { const $7 = Array.from($5.parentElement.children); const $8 = $7.indexOf($5); if ($8 === -1) { break; } const $9 = $5.parentElement.attributes['cols'].value.split(','); const $10 = $9.map((s) => parseInt(s.trim())); if ($9[$8].trim() === '*' || $10[$8] === Math.max.apply(null, $10)) { $5 = $5.parentElement; continue; } else { break; } } else { break; } } } } } if (!$2) { $1.style['display'] = 'none'; } } const $11 = $1.getBoundingClientRect(); const $12 = ($11.y < window.innerHeight - $11.height); if ($12) { $1.style['position'] = 'fixed'; $1.style['bottom'] = '0'; $1.style['left'] = '0'; $1.style['right'] = '0'; $1.style['z-index'] = '9999'; } const $13 = ( document.body.getBoundingClientRect().height < $11.height * 2 ); if ($13) { $1.style['display'] = 'none'; }
});</script></a></body>
</html>
