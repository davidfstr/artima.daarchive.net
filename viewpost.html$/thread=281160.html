
<!DOCTYPE html>

<html>
<head><meta content="noindex,nofollow" name="robots"/>
<title>Pattern matching in Scala for expressions</title>
<meta charset="utf-8"/>
<meta content="Ian Robertson" name="author">
<link href="../_/https/www.artima.com/artima.css" rel="stylesheet" type="text/css"/>
<link href="../_/https/www.artima.com/favicon.ico" rel="shortcut icon"/>
</meta></head>
<body><table cellspacing="0" width="100%">
<tr>
<td align="left" valign="bottom">
<a href="../_/https/www.artima.com/index.html"><img alt="The Artima Developer Community" border="0" height="43" src="../_/https/www.artima.com/images/a7.gif" width="550"/></a>
</td>
</tr></table>
<table bgcolor="#333333" width="100%">
<tr>
<td align="center">
<div class="ml">
<a class="hl" href="../_/https/www.artima.com/articles/index.html">Articles</a> |
<a class="hl" href="../_/https/www.artima.com/news/index.html">News</a> |
<a class="hl" href="../index.html">Weblogs</a> |
<a class="hl" href="../_/https/www.artima.com/shop/catalog/index.html">Books</a> |
<a class="hl" href="../_/https/www.artima.com/forums/index.html">Forums</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#CCCCCC" width="100%">
<tr>
<td align="center">
<div class="sc">
<a href="../index.html">Artima Weblogs</a> | 

<a href="../index.html$/blogger=ianr.html">Ian Robertson's Weblog</a> | 

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=281160.html">Discuss</a> | 
<a href="mailto:?subject=Pattern matching in Scala for expressions&amp;body= %0AArtima Weblogs %0APattern matching in Scala for expressions %0Aby Ian Robertson %0A%0Ahttps://www.artima.com/weblogs/viewpost.jsp?thread=281160">Email</a> | 
<a href="../viewpostP.html$/thread=281160.html">Print</a> | 
<a href="../bloggers.html">Bloggers</a> | 
<a class="sl" href="thread=238700.html" title="Service Locator Pattern Revisited, Part 2">Previous</a> | 
<a class="sl" href="thread=290325.html" title="Announcing Pojomatic 1.0">Next</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#EEEEEE" width="100%">
<tr>
<td align="center">
<div class="sc">
<span style="color: #555555;">Sponsored Link</span> <span style="color: #888888;">•</span>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
   if (!document.phpAds_used) document.phpAds_used = ',';
   phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
   
   document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
   document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
   document.write ("&amp;what=zone:9&amp;target=_top");   document.write ("&amp;exclude=" + document.phpAds_used);
   if (document.referrer)
      document.write ("&amp;referer=" + escape(document.referrer));
   document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a799ecf6.html" target="_top"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:9&amp;n=a0587811.html"/></a></noscript>
</div>
</td>
</tr>
</table>
<br/>
<div class="vegies">
<div class="tc">
<span class="sts">Code by Any Other Name</span><br>
<span class="ts">Pattern matching in Scala for expressions</span><br/>
<span class="as">by Ian Robertson</span><br/>
<span class="pd">January 31, 2010</span><br/>
</br></div>
<blockquote>
<b>Summary</b><br/>
Scala pattern matchers with side effects can have unexpected results in for expressions.

</blockquote>
<hr align="left" width="90%"/>
<table align="right">
<tr>
<td>
<div class="adnotice">
Advertisement
</div>
<center>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
if (!document.phpAds_used) document.phpAds_used = ',';
phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
document.write ("&amp;what=zone:2");
document.write ("&amp;exclude=" + document.phpAds_used);
if (document.referrer)
document.write ("&amp;referer=" + escape(document.referrer));
document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a74ab060.html" target="_blank"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:2&amp;n=a74ab060.html"/></a></noscript>
</center>
</td>
</tr>
</table>
<p>
Scala has taken the traditional for-construct and put it on steroids.
One of the interesting features is the ability to use pattern matching
as part of a for expression.  For example, the following:
<blockquote>
<code>
<b>case class</b> Person(firstName:String, lastName: String);<br>
<br/>
<b>val</b> people = List(<br/>
  Person("Jane", "Smith"),<br/>
  Person("John", "Doe"),<br/>
  Person("Jane", "Eyre"));<br/>
<br/>
<b>for</b> (Person("Jane", last) &lt;- people) <b>yield</b> "Ms. " + last;<br/>
</br></code>
</blockquote>

will (effectively) iterate over all people with a first name of Jane,
bind <code>last</code> to each person's last name in turn, and then
generate a list of the results of the <code><b>yield</b></code> block,
thus returning

<blockquote>
<code>
List("Ms. Smith", "Ms. Eyre")
</code>
</blockquote>

In this example, we're using a case class to provide the pattern
matching for us, but we can easily role our own.  For example,
consider the following matcher which will return the first element of
an iterator, if there is one:

<blockquote>
<code>
<b>object</b> First {<br/>
  <b>def</b> unapply[A](iter:Iterator[A]): Option[(A)] = {<br/>
    <b>if</b> (iter.hasNext) Some(iter.next) <b>else</b> None;<br/>
  }<br/>
}<br/>
</code>
</blockquote>

We can try to get the first element of some iterators:

<blockquote>
<code>
<b>val</b> iters = List(Iterator.from(1), Iterator.from(3));<br/>
<b>for</b>(First(x) &lt;- iters) <b>yield</b> x;
<code>
</code></code></blockquote>

However, this does not yield <code>List(1,3)</code> as one might
expect.  Instead, it yields <code>List(2, 4)</code>!

<p>
So what is going on here?  According to <em>Programming in Scala</em>,
a pattern match in a for loop gets converted into a filter followed by
a map.  Specifically,
<blockquote>
<code>
<b>for</b> (<i>pat</i> &lt;- <i>expr</i><sub>1</sub>) <b>yield</b> <i>expr</i><sub>2</sub>
</code>
</blockquote>
is translated by the compiler to
<blockquote>
<code>
<i>expr</i><sub>1</sub> filter {<br/>
  <b>case</b> <i>pat</i> =&gt; <b>true</b>;<br/>
  <b>case</b> _ =&gt; <b>false</b>;<br/>
} map {<br/>
  <b>case</b> <i>pat</i> =&gt; <i>expr</i><sub>2</sub>;<br/>
}
</code>
</blockquote>

In other words, first the input expression is filtered for those
elements which match the pattern, and then in a separate pass, the
pattern is applied for the purpose of
evaluating <i>expr</i><sub>2</sub>.  Unfortunately, there are a couple
of issues with this.  First, if the pattern match is computationally
expensive, that work will be doubled for every match.  Second, and
more concerning, if the pattern match is not side effect free, then
unexpected results like the one above can happen.  In the example
above, the pattern match, by calling <code>next</code> on an iterator,
changes the state of the iterator, so that a different result comes
out in the second pass.
<p>
Interestingly, <em>Programming Scala</em> states that "it's
guarannteed that a pattern-matching generator will never throw
a <code>MatchError</code>".  In fact, this is not true.  For example,
executing
<blockquote>
<code>
<b>for</b> (First(x) &lt;- List(Iterator.single(1))) <b>yield</b> x;
</code>
</blockquote>
will try to access a single-element iterator twice, resulting in:
<blockquote>
<code>
scala.MatchError: empty iterator<br/>
    at $anonfun$2.apply(&lt;console&gt;:6)<br/>
    at $anonfun$2.apply(&lt;console&gt;:6)<br/>
    at scala.List.map(List.scala:812)
</code>
</blockquote>
<p>
One way to view this situation is that Scala's <code><b>for</b></code>
construct is inherently functional, and should not be mixed with
non-functional constructs such as iterators.  However, it turns out
that there is a completely functional fix to this problem.  Simply
change the compile-time pattern-match translation to something like:

<blockquote>
<code>
<i>expr</i><sub>1</sub> map {<br/>
  <b>case</b> <i>pat</i> =&gt; Some(<i>expr</i><sub>2</sub>);<br/>
  <b>case</b> _ =&gt; None;<br/>
} filter {<br/>
  <b>case</b> Some(_) =&gt; <b>true</b>;<br/>
  <b>case</b> None =&gt; <b>false</b>;<br/>
} map {<br/>
  <b>case</b> Some(x) =&gt; x;<br/>
}
</code>
</blockquote>
or, more succinctly:
<blockquote>
<code>
<i>expr</i><sub>1</sub> map {<br/>
  <i>pat</i>.unapply(_);<br/>
} filter {<br/>
  _.isDefined;<br/>
} map {<br/>
  _.get;<br/>
}
</code>
</blockquote>
Of course, there is a cost to this approach: by introducing a third
pass, extra an extra list of <code>Option</code> objects is created.
Another fix would be to add new methods <code>filterMap</code>
and <code>filterForEach</code> which cut down the work to a single
pass.  While less elegant, it would clearly provide a performance
boost, and it would be largely hidden from view.  In the mean time,
one should use pattern matching in for expressions with care.

<h1>Talk Back!</h1>
<p>
Have an opinion?


Readers have already posted

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=281160.html">6

comments</a>
about this weblog entry. Why not

<a href="../_/https/www.artima.com/forums/post.html$/forum=106&amp;thread=281160&amp;reply=true.html">add yours</a>?


<h1>RSS Feed</h1>
<p>
If you'd like to be notified whenever Ian Robertson adds a new entry to <a href="../index.html$/blogger=ianr.html">his weblog</a>, subscribe to his <a href="../feeds/bloggers/ianr.rss">RSS feed</a>.

<center>
<div class="sociallinks">
<a href="../_/http/digg.com/submit$/phase=2&amp;url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D281160&amp;title=Pattern+matching+in+Scala+for+expressions&amp;bodytext=Scala+pattern+matchers+with+side+effects+can+have+unexpected+results+in+for+expressions.&amp;topic=programming">
<img alt="Digg" border="0" height="14" hspace="8" src="../_/https/www.artima.com/images/digg.gif" width="16">Digg
  </img></a>
  |
  <a href="../_/http/del.icio.us/post$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D281160&amp;title=Pattern+matching+in+Scala+for+expressions">
<img alt="del.icio.us" border="0" height="16" hspace="8" src="../_/https/www.artima.com/images/delicious.gif" vspace="1" width="16">del.icio.us
  </img></a>
  |
  <a href="../_/http/programming.reddit.com/submit$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D281160&amp;title=Pattern+matching+in+Scala+for+expressions">
<img alt="Reddit" border="0" height="18" hspace="8" src="../_/https/www.artima.com/images/reddit.gif" width="18"/>Reddit
  </a>
</div>
</center>
<h1>About the Blogger</h1>
<p>
<table><tr valign="bottom"><td><img align="right" src="../_/https/www.artima.com/images/ianRobertson.jpg"/></td><td>Ian Robertson is an application architect at Verisk Health. He is interested in finding concise means of expression in Java without sacrificing type safety. He contributes to various open source projects, including <a href="../_/http/www.jamon.org/index.html">jamon</a> and <a href="../_/http/www.pojomatic.org/index.html">pojomatic</a>.</td></tr></table><p>
<div class="sp">This weblog entry is Copyright © 2010 Ian Robertson. All rights reserved.</div>
</p></p></p></p></p></p></p></p></div>

<hr width="100%">
<table align="center" width="50%">
<tr>
<td>
<div class="horizontaltextadbox">
<div class="adheadline">Sponsored Links</div>
<div id="sponsoredlinks">
</div>
</div>
</td>
</tr>
</table>
<hr width="100%"/>
<center>
<script type="text/javascript"><!--
google_ad_client = "pub-3911176865765226";
google_alternate_color = "ffffff";
google_ad_width = 728;
google_ad_height = 15;
google_ad_format = "728x15_0ads_al";
google_ad_channel = "";
google_color_border = "ffffff";
google_color_bg = "FFFFFF";
google_color_link = "003090";
google_color_text = "000000";
google_color_url = "666666";
//--></script>
<script src="../_/https/pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
</script>
<br/>
<br/>
<!-- SiteSearch Google -->
<form action="../_/https/www.google.com/custom/index.html" method="get">
<table bgcolor="#ffffff" border="0">
<tr><td align="left" height="32" nowrap="nowrap" valign="top">
<a href="../_/https/www.google.com/index.html">
<img alt="Google" border="0" src="../_/https/www.google.com/logos/Logo_25wht.gif"/></a>
</td>
<td nowrap="nowrap">
<input name="domains" type="hidden" value="Artima.com"/>
<input maxlength="255" name="q" size="31" type="text" value=""/>
<input name="sa" type="submit" value="Search"/>
</td></tr>
<tr>
<td> </td>
<td nowrap="nowrap">
<font color="#000000" size="-1">
<input name="sitesearch" type="radio" value=""/> Web
<input checked="checked" name="sitesearch" type="radio" value="Artima.com"/>Artima.com
</font>  
<input name="client" type="hidden" value="pub-3911176865765226"/>
<input name="forid" type="hidden" value="1"/>
<input name="ie" type="hidden" value="ISO-8859-1"/>
<input name="oe" type="hidden" value="ISO-8859-1"/>
<input name="cof" type="hidden" value="GALT:#008000;GL:1;DIV:#336699;VLC:663399;AH:center;BGC:FFFFFF;LBGC:FFFFFF;ALC:0000FF;LC:0000FF;T:000000;GFNT:0000FF;GIMP:0000FF;LH:50;LW:150;L:https://www.artima.com/images/artima150.gif;S:https://www.artima.com;FORID:1;"/>
<input name="hl" type="hidden" value="en"/>
</td></tr></table>
</form>
<!-- SiteSearch Google -->
</center>
<br/>
<div class="sp">
<div style="text-align: center;">
<a href="../_/https/www.artima.com/copyright.html">Copyright</a> © 1996-2019 Artima, Inc. All Rights Reserved. - <a href="../_/https/www.artima.com/privacy.html">Privacy Policy</a> - <a href="../_/https/www.artima.com/termsofuse.html">Terms of Use</a>
</div>
</div>
<br/>
<script language="JavaScript" type="text/javascript">
<!--
function initBannerVarForZone(zone) {
        initBannerVarForZoneWithScript(zone, 'adjs_modified');
}

function initBannerVarForZoneWithScript(zone, phpScript) {

        if (!document.phpAds_used) document.phpAds_used = ',';
        phpAds_random = new String (Math.random());
        phpAds_random = phpAds_random.substring(2,11);

        var nextScriptSrc = '../_/https/www.artima.com/zcr/index.html' + phpScript + '.php?n=' +
                phpAds_random  +
                '&amp;what=zone:' + zone + '&amp;target=_top&amp;block=1&amp;blockcampaign=1' +
                '&amp;exclude=' + document.phpAds_used;

        document.write("<script language='JavaScript' type='text/javascript' src='");
        document.write(nextScriptSrc);
        document.write("'><\/script>");

}

function replaceDiv(divID) {
        document.getElementById(divID).innerHTML = phpadsbanner;
}
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZone(3);
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('leftskyscraper');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZoneWithScript(4, 'textman');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('sponsoredlinks');
-->
</script>
</hr><a href="https://dafoster.net/projects/crystal-web-archiver/" id="cr-footer-banner" style="border-top: 2px #B40010 solid;background: #FFFAE1;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;font-variant: initial;font-weight: initial;text-transform: none;font-size: 14px;color: #6c757d;line-height: 2.0;cursor: pointer;display: flex;align-items: center;justify-content: center;gap: 4px;clear: both;" target="_blank"><img height="24" onerror="this.style['display'] = 'none';" src="../_/crystal/resources/appicon.png" width="24"/><span>This page was archived with Crystal</span><script>window.addEventListener('load', function() { const $1 = document.querySelector('#cr-footer-banner'); if (!$1) { return; } if (window !== window.top) { let $2 = false; if (window.name) { const $3 = window.parent.document.getElementsByName(window.name); if ($3.length === 1) { const $4 = $3[0]; if ($4.tagName === 'FRAME' && $4.parentElement.tagName === 'FRAMESET') { let $5 = $4; while (true) { if ($5.parentElement.tagName !== 'FRAMESET') { $2 = true; break; } if ($5.parentElement.attributes['rows'] !== undefined) { const $6 = $5.parentElement.children; if ($5 === $6[$6.length - 1]) { $5 = $5.parentElement; continue; } else { break; } } else if ($5.parentElement.attributes['cols'] !== undefined) { const $7 = Array.from($5.parentElement.children); const $8 = $7.indexOf($5); if ($8 === -1) { break; } const $9 = $5.parentElement.attributes['cols'].value.split(','); const $10 = $9.map((s) => parseInt(s.trim())); if ($9[$8].trim() === '*' || $10[$8] === Math.max.apply(null, $10)) { $5 = $5.parentElement; continue; } else { break; } } else { break; } } } } } if (!$2) { $1.style['display'] = 'none'; } } const $11 = $1.getBoundingClientRect(); const $12 = ($11.y < window.innerHeight - $11.height); if ($12) { $1.style['position'] = 'fixed'; $1.style['bottom'] = '0'; $1.style['left'] = '0'; $1.style['right'] = '0'; $1.style['z-index'] = '9999'; } const $13 = ( document.body.getBoundingClientRect().height < $11.height * 2 ); if ($13) { $1.style['display'] = 'none'; }
});</script></a></body>
</html>
