
<!DOCTYPE html>

<html>
<head><meta content="noindex,nofollow" name="robots"/>
<title>Indexable Stacks and Programming with Contracts</title>
<meta charset="utf-8"/>
<meta content="Christopher Diggins" name="author">
<link href="../_/https/www.artima.com/artima.css" rel="stylesheet" type="text/css"/>
<link href="../_/https/www.artima.com/favicon.ico" rel="shortcut icon"/>
</meta></head>
<body><table cellspacing="0" width="100%">
<tr>
<td align="left" valign="bottom">
<a href="../_/https/www.artima.com/index.html"><img alt="The Artima Developer Community" border="0" height="43" src="../_/https/www.artima.com/images/a7.gif" width="550"/></a>
</td>
</tr></table>
<table bgcolor="#333333" width="100%">
<tr>
<td align="center">
<div class="ml">
<a class="hl" href="../_/https/www.artima.com/articles/index.html">Articles</a> |
<a class="hl" href="../_/https/www.artima.com/news/index.html">News</a> |
<a class="hl" href="../index.html">Weblogs</a> |
<a class="hl" href="../_/https/www.artima.com/shop/catalog/index.html">Books</a> |
<a class="hl" href="../_/https/www.artima.com/forums/index.html">Forums</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#CCCCCC" width="100%">
<tr>
<td align="center">
<div class="sc">
<a href="../index.html">Artima Weblogs</a> | 

<a href="../index.html$/blogger=cdiggins.html">Christopher Diggins' Weblog</a> | 

<a href="../_/https/www.artima.com/forums/flat.html$/forum=106&amp;thread=137357.html">Discuss</a> | 
<a href="mailto:?subject=Indexable Stacks and Programming with Contracts&amp;body= %0AArtima Weblogs %0AIndexable Stacks and Programming with Contracts %0Aby Christopher Diggins %0A%0Ahttps://www.artima.com/weblogs/viewpost.jsp?thread=137357">Email</a> | 
<a href="../viewpostP.html$/thread=137357.html">Print</a> | 
<a href="../bloggers.html">Bloggers</a> | 
<a class="sl" href="thread=137019.html" title="A Faster Growable Array ( Indexable Stack ) for C++">Previous</a> | 
<a class="sl" href="thread=137924.html" title="Persistent Hash-Tables and Why Wikipedia Still Sucks at Computer Science">Next</a>
</div>
</td>
</tr>
</table>
<table bgcolor="#EEEEEE" width="100%">
<tr>
<td align="center">
<div class="sc">
<span style="color: #555555;">Sponsored Link</span> <span style="color: #888888;">•</span>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
   if (!document.phpAds_used) document.phpAds_used = ',';
   phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
   
   document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
   document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
   document.write ("&amp;what=zone:9&amp;target=_top");   document.write ("&amp;exclude=" + document.phpAds_used);
   if (document.referrer)
      document.write ("&amp;referer=" + escape(document.referrer));
   document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a799ecf6.html" target="_top"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:9&amp;n=a0587811.html"/></a></noscript>
</div>
</td>
</tr>
</table>
<br/>
<div class="vegies">
<div class="tc">
<span class="sts">Heron-Centric: Ruminations of a Language Designer</span><br>
<span class="ts">Indexable Stacks and Programming with Contracts</span><br/>
<span class="as">by Christopher Diggins</span><br/>
<span class="pd">November 18, 2005</span><br/>
</br></div>
<blockquote>
<b>Summary</b><br/>
The growable array I posted about two days ago has evolved into a full-featured stack template class with more features, more tests, better performance and contract verification.

</blockquote>
<hr align="left" width="90%"/>
<table align="right">
<tr>
<td>
<div class="adnotice">
Advertisement
</div>
<center>
<script language="JavaScript" src="../_/https/www.artima.com/zcr/adx.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
if (!document.phpAds_used) document.phpAds_used = ',';
phpAds_random = new String (Math.random()); phpAds_random = phpAds_random.substring(2,11);
document.write ("<" + "script language='JavaScript' type='text/javascript' src='");
document.write ("../_/https/www.artima.com/zcr/adjs.html$/n=.html" + phpAds_random);
document.write ("&amp;what=zone:2");
document.write ("&amp;exclude=" + document.phpAds_used);
if (document.referrer)
document.write ("&amp;referer=" + escape(document.referrer));
document.write ("'><" + "/script>");
//-->
</script><noscript><a href="../_/https/www.artima.com/zcr/adclick.html$/n=a74ab060.html" target="_blank"><img alt="" border="0" src="../_/https/www.artima.com/zcr/adview.html$/what=zone:2&amp;n=a74ab060.html"/></a></noscript>
</center>
</td>
</tr>
</table>
<p>
The performance of the OOTL stack class has improved significantly with the use of std::allocator, and the addition of contract verification. The latest version is at <a href="../_/http/www.ootl.org/index.html">OOTL.org</a>. 
<p>
Here are some benchmark results for containers of 12.8 million elements:

<pre>
benchmarking : grow_vector(vec, count) = 1015 msec
benchmarking : grow_vector(deq, count) = 734 msec
benchmarking : grow_stack(stk, count) = 577 msec
benchmarking : grow_vector(vec, "hello", count / 40) = 1420 msec
benchmarking : grow_vector(deq, "hello", count / 40) = 1047 msec
benchmarking : grow_stack(stk, "hello", count / 40) = 953 msec
benchmarking : grow_vector(vec, fubar(), count / 10) = 1875 msec
benchmarking : grow_vector(deq, fubar(), count / 10) = 717 msec
benchmarking : grow_stack(stk, fubar(), count / 10) = 578 msec
benchmarking : vector_indexing(vec) = 593 msec
benchmarking : vector_indexing(fixed_deq) = 6749 msec
benchmarking : vector_indexing(grown_deq) = 6733 msec
benchmarking : stack_indexing(fixed_stack) = 890 msec
benchmarking : stack_indexing(grown_stack) = 1171 msec
benchmarking : vector_iteration(vec) = 1358 msec
benchmarking : vector_iteration(fixed_deq) = 1546 msec
benchmarking : vector_iteration(grown_deq) = 1546 msec
benchmarking : stack_iteration(fixed_stack) = 1219 msec
benchmarking : stack_iteration(grown_stack) = 1297 msec 
</pre>


To summarize the results, vectors are slow at individual element growth using the <tt>push_back()</tt> member function, sometimes more than 3x than the stack. The variation depends on how expensive copy operations are. An extremely expensive copy operation will cause the vector to suffer greatly. The other thing I want you to notice is that deques are very very bad at indexing, 6x as slow as the stack! The difference between <tt>fixed_stack</tt> and <tt>grown_stack</tt> is due to the fact that if initialized with a specific size the data structure allocates a single large initial buffer, rather than needing to create a long doubling list. 
<p>
As I mentioned previously the data structure used, is a "reverse doubling list" (does anyone know if this exist under a prior name?) which is a linked list of arrays each one twice the size as the next. Lookups take an average constant time in this data structure, with a worst case of O(Log N). 
<p>
The recent versions uses the latest techniques I've developed for programming with contracts, which are more effective previous incarnations. Here is what the contract verification class looks like: 

<pre>
template
&lt;
  typename Implementation,
  typename Inherited
&gt;
struct stack_contract : Inherited
{
  // public typedef
  typedef Inherited inh;
  typedef Implementation impl;
  typedef typename inh::value_type value_type;

  // constructors
  stack_contract() : inh() { }
  stack_contract(impl&amp; x) : inh(x) { }
  stack_contract(int nsize, value_type x = value_type()) : inh(nsize, x) { }

  // public functions
  void pop() {
    int old = inh::count();
    assert(!inh::is_empty());
    inh::pop();
    assert(count() == old - 1);
  }
  void push(const value_type&amp; x) {
    int old = inh::count();
    inh::push(x);
    assert(inh::count() == old + 1);
  }
  value_type&amp; top() {
    assert(!inh::is_empty());
    value_type&amp; ret = inh::top();
    value_type&amp; tmp = inh::operator[](inh::count() - 1);
    assert(&amp;ret == &amp;tmp);
    return ret;
  }
  int count() {
    int ret = inh::count();
    assert(ret &gt;= 0);
    assert(ret &gt; 0 ? !inh::is_empty() : inh::is_empty());
    return ret;
  }
  bool is_empty() {
    bool ret = inh::is_empty();
    assert(ret ? inh::count() == 0 : inh::count() &gt; 0);
    return ret;
  }
  value_type&amp; operator[](int n) {
    assert(n &gt;= 0);
    assert(n &lt; inh::count());
    return inh::operator[](n);
  }
};
</pre>

The contract is applied to the stack implementation as follows: 

<pre>
#ifndef _NDEBUG
  template
  &lt;
    typename T,
    typename Implementation = indexable_stack_impl&lt;T&gt;,
    typename Contract = stack_contract&lt;Implementation, Implementation&gt;,
    typename Extension = stack_extension&lt;Implementation, Contract&gt;
  &gt;
  struct stack : Extension
  {
    typedef Implementation impl;
    typedef Extension inh;
    stack() : inh() { }
    stack(impl&amp; x) : inh(impl&amp; x) { }
    stack(int nsize, const T&amp; x = T()) : inh(nsize, x) { }
  };
#else
  template
  &lt;
    typename T,
    typename Implementation = indexable_stack_impl&lt;T&gt;,
    typename Extension = stack_extension&lt;Implementation, Implementation&gt;
  &gt;
  struct stack : Extension
  {
    typedef Implementation impl;
    typedef Extension inh;
    stack() : inh() { }
    stack(impl&amp; x) : inh(x) { }
    stack(int nsize, const T&amp; x = T()) : inh(nsize, x) { }
  };
#endif
</pre>

The reason it is so great to have the contract separated like this is for two main reasons:
<ol>
<li>the contract is separated into a logical and cohesive unit which is easier to read and understand, and can serve as a standalone description of the implementation class.
</li>
<li>the logic of the implementation remains unaffected by the verification of preconditions and postconditions
</li>
</ol>

To understand the significance of number 2 consider the <tt>pop()</tt> function. Traditional programming techniques would have preconditions and postconditions checked directly within the function implementation. For instance, the <tt>pop()</tt> function would have to be written as: 

<pre>
  void pop() {
    int old = inh::count();
    assert(!inh::is_empty());
    ...
    assert(count() == old - 1);
  }
</pre>

But the problem with this approach is that during release builds there remains a superflous variable declaration and a superflous call to <tt>count()</tt>. In this trivial example the compiler might be able to optimize the calls away, but in other less trivial cases it won't be able to do so. By separating the entire contract verification into a separate class, all of the logic is applied (or not) depending on the _NDEBUG macro.
<p>
I hope some of this code I am developing is useful, the <a href="../_/http/www.ootl.org/index.html">download</a> is public domain, so you can use it to your heart's content. If you need help with it, let me know.

<h1>Talk Back!</h1>
<p>
Have an opinion?


Be the first to

<a href="../_/https/www.artima.com/forums/post.html$/forum=106&amp;thread=137357&amp;reply=true.html">post a comment</a> about
this weblog entry.


<h1>RSS Feed</h1>
<p>
If you'd like to be notified whenever Christopher Diggins adds a new entry to <a href="../index.html$/blogger=cdiggins.html">his weblog</a>, subscribe to his <a href="../feeds/bloggers/cdiggins.rss">RSS feed</a>.

<center>
<div class="sociallinks">
<a href="../_/http/digg.com/submit$/phase=2&amp;url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D137357&amp;title=Indexable+Stacks+and+Programming+with+Contracts&amp;bodytext=The+growable+array+I+posted+about+two+days+ago+has+evolved+into+a+full-featured+stack+template+class+with+more+features%2C+more+tests%2C+better+performance+and+contract+verification.&amp;topic=programming">
<img alt="Digg" border="0" height="14" hspace="8" src="../_/https/www.artima.com/images/digg.gif" width="16">Digg
  </img></a>
  |
  <a href="../_/http/del.icio.us/post$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D137357&amp;title=Indexable+Stacks+and+Programming+with+Contracts">
<img alt="del.icio.us" border="0" height="16" hspace="8" src="../_/https/www.artima.com/images/delicious.gif" vspace="1" width="16">del.icio.us
  </img></a>
  |
  <a href="../_/http/programming.reddit.com/submit$/url=http%3A%2F%2Fwww.artima.com%2Fweblogs%2Fviewpost.jsp%3Fthread%3D137357&amp;title=Indexable+Stacks+and+Programming+with+Contracts">
<img alt="Reddit" border="0" height="18" hspace="8" src="../_/https/www.artima.com/images/reddit.gif" width="18"/>Reddit
  </a>
</div>
</center>
<h1>About the Blogger</h1>
<p>
<table><tr valign="bottom"><td><img align="right" src="../_/https/www.artima.com/images/christopherdiggins.jpg"/></td><td>Christopher Diggins is a software developer and freelance writer. Christopher loves programming, but is eternally frustrated by the shortcomings of modern programming languages. As would any reasonable person in his shoes, he decided to quit his day job to write his own ( <a href="../_/http/www.heron-language.com/index.html">www.heron-language.com</a> ). Christopher is the co-author of the <a href="../_/http/www.cpp-cookbook.com/index.html">C++ Cookbook</a> from O'Reilly. Christopher can be reached through his home page at  <a href="../_/http/www.cdiggins.com/index.html">www.cdiggins.com</a>.</td></tr></table><p>
<div class="sp">This weblog entry is Copyright © 2005 Christopher Diggins. All rights reserved.</div>
</p></p></p></p></p></p></p></p></p></div>

<hr width="100%">
<table align="center" width="50%">
<tr>
<td>
<div class="horizontaltextadbox">
<div class="adheadline">Sponsored Links</div>
<div id="sponsoredlinks">
</div>
</div>
</td>
</tr>
</table>
<hr width="100%"/>
<center>
<script type="text/javascript"><!--
google_ad_client = "pub-3911176865765226";
google_alternate_color = "ffffff";
google_ad_width = 728;
google_ad_height = 15;
google_ad_format = "728x15_0ads_al";
google_ad_channel = "";
google_color_border = "ffffff";
google_color_bg = "FFFFFF";
google_color_link = "003090";
google_color_text = "000000";
google_color_url = "666666";
//--></script>
<script src="../_/https/pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
</script>
<br>
<br/>
<!-- SiteSearch Google -->
<form action="../_/https/www.google.com/custom/index.html" method="get">
<table bgcolor="#ffffff" border="0">
<tr><td align="left" height="32" nowrap="nowrap" valign="top">
<a href="../_/https/www.google.com/index.html">
<img alt="Google" border="0" src="../_/https/www.google.com/logos/Logo_25wht.gif"/></a>
</td>
<td nowrap="nowrap">
<input name="domains" type="hidden" value="Artima.com"/>
<input maxlength="255" name="q" size="31" type="text" value=""/>
<input name="sa" type="submit" value="Search"/>
</td></tr>
<tr>
<td> </td>
<td nowrap="nowrap">
<font color="#000000" size="-1">
<input name="sitesearch" type="radio" value=""/> Web
<input checked="checked" name="sitesearch" type="radio" value="Artima.com"/>Artima.com
</font>  
<input name="client" type="hidden" value="pub-3911176865765226"/>
<input name="forid" type="hidden" value="1"/>
<input name="ie" type="hidden" value="ISO-8859-1"/>
<input name="oe" type="hidden" value="ISO-8859-1"/>
<input name="cof" type="hidden" value="GALT:#008000;GL:1;DIV:#336699;VLC:663399;AH:center;BGC:FFFFFF;LBGC:FFFFFF;ALC:0000FF;LC:0000FF;T:000000;GFNT:0000FF;GIMP:0000FF;LH:50;LW:150;L:https://www.artima.com/images/artima150.gif;S:https://www.artima.com;FORID:1;"/>
<input name="hl" type="hidden" value="en"/>
</td></tr></table>
</form>
<!-- SiteSearch Google -->
</br></center>
<br/>
<div class="sp">
<div style="text-align: center;">
<a href="../_/https/www.artima.com/copyright.html">Copyright</a> © 1996-2019 Artima, Inc. All Rights Reserved. - <a href="../_/https/www.artima.com/privacy.html">Privacy Policy</a> - <a href="../_/https/www.artima.com/termsofuse.html">Terms of Use</a>
</div>
</div>
<br/>
<script language="JavaScript" type="text/javascript">
<!--
function initBannerVarForZone(zone) {
        initBannerVarForZoneWithScript(zone, 'adjs_modified');
}

function initBannerVarForZoneWithScript(zone, phpScript) {

        if (!document.phpAds_used) document.phpAds_used = ',';
        phpAds_random = new String (Math.random());
        phpAds_random = phpAds_random.substring(2,11);

        var nextScriptSrc = '../_/https/www.artima.com/zcr/index.html' + phpScript + '.php?n=' +
                phpAds_random  +
                '&amp;what=zone:' + zone + '&amp;target=_top&amp;block=1&amp;blockcampaign=1' +
                '&amp;exclude=' + document.phpAds_used;

        document.write("<script language='JavaScript' type='text/javascript' src='");
        document.write(nextScriptSrc);
        document.write("'><\/script>");

}

function replaceDiv(divID) {
        document.getElementById(divID).innerHTML = phpadsbanner;
}
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZone(3);
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('leftskyscraper');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
initBannerVarForZoneWithScript(4, 'textman');
-->
</script>
<script language="JavaScript" type="text/javascript">
<!--
replaceDiv('sponsoredlinks');
-->
</script>
</hr><a href="https://dafoster.net/projects/crystal-web-archiver/" id="cr-footer-banner" style="border-top: 2px #B40010 solid;background: #FFFAE1;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;font-variant: initial;font-weight: initial;text-transform: none;font-size: 14px;color: #6c757d;line-height: 2.0;cursor: pointer;display: flex;align-items: center;justify-content: center;gap: 4px;clear: both;" target="_blank"><img height="24" onerror="this.style['display'] = 'none';" src="../_/crystal/resources/appicon.png" width="24"/><span>This page was archived with Crystal</span><script>window.addEventListener('load', function() { const $1 = document.querySelector('#cr-footer-banner'); if (!$1) { return; } if (window !== window.top) { let $2 = false; if (window.name) { const $3 = window.parent.document.getElementsByName(window.name); if ($3.length === 1) { const $4 = $3[0]; if ($4.tagName === 'FRAME' && $4.parentElement.tagName === 'FRAMESET') { let $5 = $4; while (true) { if ($5.parentElement.tagName !== 'FRAMESET') { $2 = true; break; } if ($5.parentElement.attributes['rows'] !== undefined) { const $6 = $5.parentElement.children; if ($5 === $6[$6.length - 1]) { $5 = $5.parentElement; continue; } else { break; } } else if ($5.parentElement.attributes['cols'] !== undefined) { const $7 = Array.from($5.parentElement.children); const $8 = $7.indexOf($5); if ($8 === -1) { break; } const $9 = $5.parentElement.attributes['cols'].value.split(','); const $10 = $9.map((s) => parseInt(s.trim())); if ($9[$8].trim() === '*' || $10[$8] === Math.max.apply(null, $10)) { $5 = $5.parentElement; continue; } else { break; } } else { break; } } } } } if (!$2) { $1.style['display'] = 'none'; } } const $11 = $1.getBoundingClientRect(); const $12 = ($11.y < window.innerHeight - $11.height); if ($12) { $1.style['position'] = 'fixed'; $1.style['bottom'] = '0'; $1.style['left'] = '0'; $1.style['right'] = '0'; $1.style['z-index'] = '9999'; } const $13 = ( document.body.getBoundingClientRect().height < $11.height * 2 ); if ($13) { $1.style['display'] = 'none'; }
});</script></a></body>
</html>
